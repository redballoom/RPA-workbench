# 性能趋势添加日/月维度筛选方案

> 2026-02-02

---

## 一、需求概述

在"性能趋势"图表的标题栏位置添加维度切换下拉框，支持：
- **日趋势**：按天显示（当前实现）
- **月趋势**：按月汇总显示

---

## 二、当前实现

### 2.1 位置

```
性能趋势
[More按钮]  ← 替换为下拉框
```

### 2.2 当前 API

```
GET /api/v1/dashboard/performance?days=7
```

- 参数：`days` (1-30)
- 返回：按天分组的统计数据

---

## 三、实现方案

### 3.1 后端修改

#### 3.1.1 新增 API 参数

```
GET /api/v1/dashboard/performance?days=7&dimension=day
```

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| days | int | 7 | 查询天数 |
| dimension | string | "day" | 维度：day/month |

#### 3.1.2 修改仓库层

**文件**：`backend/app/repositories/log_repository.py`

**修改内容**：
```python
async def get_stats_by_dimension(
    self,
    start_date=None,
    end_date=None,
    timezone: str = "Asia/Shanghai",
    dimension: str = "day",  # 新增参数
) -> List[Dict[str, Any]]:
    """
    Get statistics by dimension (day or month)

    Args:
        dimension: 'day' for daily, 'month' for monthly
    """
    # 按 dimension 选择日期格式
    if dimension == "month":
        date_expr = "strftime('%Y-%m', start_time)"  # 按月分组
    else:
        date_expr = "strftime('%Y-%m-%d', start_time)"  # 按天分组

    # ... 其余逻辑相同
```

#### 3.1.3 修改 API 层

**文件**：`backend/app/api/v1/dashboard.py`

```python
@router.get("/performance")
async def get_performance_trends(
    days: int = Query(default=7, ge=1, le=365, description="Number of days to analyze"),
    dimension: str = Query(default="day", description="Dimension: 'day' or 'month'"),
    timezone: str = Query(default="Asia/Shanghai", description="Timezone"),
    db: AsyncSession = Depends(get_db),
):
    """
    Get performance trends - support day/month dimension

    - **days**: Number of days to analyze (1-365)
    - **dimension**: 'day' (default) or 'month'
    """
    service = DashboardService(db)
    return await service.get_performance_trends(
        days=days,
        timezone=timezone,
        dimension=dimension,  # 新增参数
    )
```

### 3.2 前端修改

#### 3.2.1 新增状态

```typescript
const [performanceDimension, setPerformanceDimension] = useState<'day' | 'month'>('day');
```

#### 3.2.2 添加下拉框组件

```tsx
<div className="relative">
  <select
    value={performanceDimension}
    onChange={(e) => setPerformanceDimension(e.target.value as 'day' | 'month')}
    className="appearance-none bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 px-3 py-1 pr-8 rounded-lg text-sm font-medium hover:bg-slate-200 dark:hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-indigo-500"
  >
    <option value="day">日趋势</option>
    <option value="month">月趋势</option>
  </select>
  {/* 下拉箭头图标 */}
  <ChevronDown className="absolute right-2 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-500 pointer-events-none" />
</div>
```

#### 3.2.3 修改数据加载

```typescript
const performanceData = performance?.dailyStats.map(stat => ({
  name: dimension === 'month'
    ? new Date(stat.date).toLocaleDateString('zh-CN', { year: 'numeric', month: 'short' })
    : new Date(stat.date).toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' }),
  value: stat.totalExecutions
})) || [];
```

---

## 四、效果预览

### 日趋势（默认）

```
┌────────────────────────────┐
│ 性能趋势  [日趋势 ▼]        │ ← 下拉选择
├────────────────────────────┤
│  1月30日  ▂▃▅▆▇▆▅▃▂       │
│  1月31日  ▂▃▅▆▇▆▅▃▂       │
│  2月1日   ▂▃▅▆▇▆▅▃▂       │
└────────────────────────────┘
```

### 月趋势

```
┌────────────────────────────┐
│ 性能趋势  [月趋势 ▼]        │ ← 下拉选择
├────────────────────────────┤
│  2025年1月  ▂▃▅▆▇▆▅▃▂     │
│  2025年2月  ▂▃▅▆▇▆▅▃▂     │
└────────────────────────────┘
```

---

## 五、修改文件清单

| 文件 | 修改内容 |
|------|----------|
| `backend/app/repositories/log_repository.py` | 支持按月分组查询 |
| `backend/app/api/v1/dashboard.py` | 添加 dimension 参数 |
| `backend/app/services/dashboard_service.py` | 传递 dimension 参数 |
| `frontend/src/lib/api.ts` | 添加 dimension 参数到 API 调用 |
| `frontend/src/pages/Dashboard.tsx` | 添加下拉框组件和状态管理 |

---

## 六、数据量影响

| 维度 | 数据点数 | 适用场景 |
|------|----------|----------|
| 日趋势 | 7-30 个点 | 短期趋势分析 |
| 月趋势 | 1-12 个点（7天数据范围内） | 长期趋势分析 |

**注意**：月趋势在 7 天数据范围内最多只有 1 个月的数据点，建议配合更大的 `days` 参数使用（如 90 或 180 天）。

---

## 七、待确认

1. **月趋势默认天数**：是否需要调整默认 `days` 参数？（当前 7 天，月趋势可能需要更大范围）
2. **数据范围**：月趋势建议查询多少天？（建议 90 天或 180 天）
3. **UI 样式**：下拉框样式是否符合项目风格？
