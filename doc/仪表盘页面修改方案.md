# 仪表盘页面修改方案

> 创建日期: 2026-01-30
> 作者: Claude Code

---

## 一、需求概述

| 需求项 | 说明 |
|--------|------|
| 性能趋势 | 缩短高度，更紧凑 |
| 新增排行榜 | 任务执行时间排行榜 |
| 状态分布 | 保持不变 |

---

## 二、修改详情

### 2.1 性能趋势板块（更紧凑）

**修改前:**
```tsx
<div className="h-80">
  <ResponsiveContainer width="100%" height="100%">
    <AreaChart ...>
```

**修改后:**
```tsx
<div className="h-48">  // 约 192px
  <ResponsiveContainer width="100%" height="100%">
    <AreaChart ...>
```

**同时调整:**
- 外层 padding: `p-6` → `p-4`
- 字体大小可适当缩小

---

### 2.2 新增任务执行时间排行榜

**设计:**
- 位置：性能趋势和任务状态分布之间
- 布局：三栏等宽（各占 1/3）
- **UI 风格**: 与其他卡片完全一致

**数据规则:**
| 规则 | 说明 |
|------|------|
| 数据来源 | 所有执行记录（成功+失败） |
| 时间范围 | 全部历史数据 |
| 排序方式 | 按平均执行时长降序 |
| 显示数量 | Top 10 |
| 高度自适应 | 元素不够时增加高度以保持美观 |

**组件结构（与其他卡片保持一致）:**
```tsx
<div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm p-6 border border-slate-200 dark:border-slate-700">
  {/* 标题区 - 与其他卡片一致 */}
  <div className="flex justify-between items-center mb-6">
    <h2 className="text-lg font-semibold text-slate-900 dark:text-white">任务执行时间排行</h2>
    <button className="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700">
      <MoreHorizontal className="h-5 w-5 text-slate-500 dark:text-slate-400" />
    </button>
  </div>

  {/* 列表区 - 与任务状态分布的图例区风格一致 */}
  <div className="space-y-3">
    {rankData.map((item, index) => (
      <div key={item.app_name} className="flex items-center justify-between">
        <div className="flex items-center min-w-0 flex-1">
          <span className="text-slate-400 mr-2 text-sm w-5">{index + 1}</span>
          <span className="truncate text-sm text-slate-700 dark:text-slate-300">
            {item.app_name}
          </span>
        </div>
        <span className="text-sm font-medium text-slate-900 dark:text-white ml-2">
          {formatDuration(item.avg_duration)}
          <span className="text-slate-400 font-normal ml-1">({item.execution_count}次)</span>
        </span>
      </div>
    ))}
  </div>

  {/* 空状态 - 与其他卡片一致 */}
  {rankData.length === 0 && (
    <div className="flex flex-col items-center justify-center py-8 text-center">
      <TerminalSquare className="h-8 w-8 text-slate-300 dark:text-slate-600 mb-2" />
      <p className="text-sm text-slate-500 dark:text-slate-400">暂无排行数据</p>
    </div>
  )}
</div>
```

**数据结构:**
```typescript
interface ExecutionRank {
  app_name: string;        // 应用名称
  avg_duration: number;    // 平均执行时长（秒）
  execution_count: number; // 执行次数
}

interface ExecutionRankResponse {
  items: ExecutionRank[];
  generated_at: string;
}
```

---

### 2.3 布局调整

**修改前布局:**
```
┌────────────────────┬────────────┐
│   性能趋势         │ 任务状态   │
│   (宽 2/3)         │  分布      │
│                    │            │
├────────────────────┴────────────┤
│       最近执行记录              │
└───────────────────────────────┘
```

**修改后布局:**
```
┌─────────────┬─────────────┬────────────┐
│  性能趋势   │ 执行时间    │  任务状态  │
│  (紧凑)     │  排行榜     │   分布     │
│             │             │            │
└─────────────┴─────────────┴────────────┘
```

**Tailwind 类名:**
```tsx
// 修改前
<div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <div className="lg:col-span-2">性能趋势</div>
  <div>任务状态分布</div>
</div>

// 修改后
<div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
  <div className="lg:col-span-1">性能趋势（紧凑）</div>
  <div className="lg:col-span-1">执行时间排行榜</div>
  <div className="lg:col-span-1">任务状态分布</div>
</div>
```

---

## 三、后端 API 新增

### 3.1 新增端点

**请求:**
```
GET /api/v1/dashboard/execution-rank?limit=10
```

**响应:**
```json
{
  "items": [
    {
      "app_name": "订单处理",
      "avg_duration": 125.5,
      "execution_count": 23
    },
    {
      "app_name": "数据同步",
      "avg_duration": 89.2,
      "execution_count": 45
    }
  ],
  "generated_at": "2026-01-30T10:00:00Z"
}
```

### 3.2 实现逻辑

```python
# backend/app/repositories/execution_log_repository.py

async def get_execution_rank(self, limit: int = 10) -> list[dict]:
    """获取任务执行时长排行榜"""
    query = select(
        ExecutionLog.app_name,
        func.avg(ExecutionLog.duration).label('avg_duration'),
        func.count(ExecutionLog.id).label('execution_count')
    ).where(
        ExecutionLog.status == 'completed'
    ).group_by(
        ExecutionLog.app_name
    ).order_by(
        desc('avg_duration')
    ).limit(limit)

    result = await self.db.execute(query)
    return [
        {
            "app_name": row.app_name,
            "avg_duration": round(row.avg_duration, 1),
            "execution_count": row.execution_count
        }
        for row in result.fetchall()
    ]
```

---

## 四、前端修改

### 4.1 API 类型定义

**文件**: `frontend/src/lib/api.ts`

```typescript
export interface ExecutionRank {
  app_name: string;
  avg_duration: number;
  execution_count: number;
}

export interface ExecutionRankResponse {
  items: ExecutionRank[];
  generated_at: string;
}

// 在 dashboardApi 中新增
export const dashboardApi = {
  // ... 现有方法

  // 新增：获取执行排行榜
  async getExecutionRank(limit: number = 10): Promise<ExecutionRankResponse> {
    return request<ExecutionRankResponse>(`/dashboard/execution-rank?limit=${limit}`);
  },
};
```

### 4.2 Dashboard.tsx 修改

**新增状态:**
```typescript
const [executionRank, setExecutionRank] = useState<ExecutionRank[]>([]);
```

**新增数据加载:**
```typescript
const [statsData, performanceData, logsData, rankData] = await Promise.all([
  dashboardApi.getStats(),
  dashboardApi.getPerformance(7),
  logsApi.getLogs({ page: 1, page_size: 5 }),
  dashboardApi.getExecutionRank(10),  // 新增
]);

setExecutionRank(rankData.items || []);
```

**新增排行榜组件:**
```tsx
<div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm p-4 border border-slate-200 dark:border-slate-700">
  <h3 className="text-sm font-semibold text-slate-900 dark:text-white mb-3">
    任务执行时间排行
  </h3>
  <div className="space-y-2">
    {executionRank.map((item, index) => (
      <div key={item.app_name} className="flex items-center justify-between text-sm">
        <div className="flex items-center min-w-0">
          <span className="text-slate-400 mr-2">{index + 1}</span>
          <span className="truncate text-slate-700 dark:text-slate-300">
            {item.app_name}
          </span>
        </div>
        <span className="text-slate-500 dark:text-slate-400 ml-2">
          {formatDuration(item.avg_duration)} ({item.execution_count}次)
        </span>
      </div>
    ))}
  </div>
  {executionRank.length === 0 && (
    <p className="text-sm text-slate-400 text-center py-4">暂无数据</p>
  )}
</div>
```

### 4.3 整体布局调整

```tsx
// 修改前
<div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
  {/* 性能趋势 */}
  <div className="bg-white ... p-6 border ... lg:col-span-2">
    <div className="h-80">...</div>
  </div>
  {/* 任务状态分布 */}
  <div className="bg-white ... p-6 border ...">...</div>
</div>

// 修改后
<div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
  {/* 性能趋势 - 紧凑 */}
  <div className="bg-white ... p-4 border ...">
    <div className="h-48">...</div>
  </div>
  {/* 执行时间排行榜 - 新增 */}
  <div className="bg-white ... p-4 border ...">...</div>
  {/* 任务状态分布 */}
  <div className="bg-white ... p-4 border ...">...</div>
</div>
```

---

## 五、修改文件清单

| 文件 | 操作 | 说明 |
|------|------|------|
| `backend/app/api/v1/dashboard.py` | 修改 | 新增 `/execution-rank` 接口 |
| `backend/app/repositories/execution_log_repository.py` | 修改 | 新增 `get_execution_rank` 方法 |
| `frontend/src/lib/api.ts` | 修改 | 新增类型定义和 API 调用 |
| `frontend/src/pages/Dashboard.tsx` | 修改 | 调整布局，新增排行榜展示 |

---

## 六、验证步骤

1. **前端构建**
   ```bash
   cd frontend
   pnpm build
   ```

2. **功能验证**
   - [ ] 性能趋势图表高度是否合适
   - [ ] 排行榜数据是否按执行时长排序
   - [ ] 任务状态分布是否正常显示
   - [ ] 整体布局是否协调

3. **响应式测试**
   - [ ] 移动端单列布局
   - [ ] 桌面端三列布局

---

## 七、时间预估

| 任务 | 预估工作量 |
|------|-----------|
| 后端 API 开发 | 30 分钟 |
| 前端 API 类型 | 10 分钟 |
| 前端组件开发 | 45 分钟 |
| 测试和调试 | 15 分钟 |
| **总计** | **约 1.5 小时** |

---

## 八、附加说明

### 排行榜排序规则
- 默认按平均执行时长降序（最长 → 最短）
- 可扩展支持升序排列
- 可扩展支持按执行次数排序

### 性能考虑
- 排行榜数据量小（Top 10），无需特殊优化
- 可添加缓存（复用 performance 的缓存机制）

### 后续扩展
- 支持按时间段筛选
- 支持导出排行榜数据
- 添加执行时长趋势图
