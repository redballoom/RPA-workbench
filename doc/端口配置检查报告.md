# 端口配置检查报告

> 2026-02-02

## 检查范围

- 前端：React/Vite 项目
- 后端：FastAPI 项目
- 不包含：内网穿透相关配置

---

## 检查结果

### 前端

| 文件位置 | 硬编码内容 | 严重程度 | 说明 |
|---------|-----------|---------|------|
| `frontend/src/lib/api.ts:9` | `http://localhost:8888/api/v1` | ⚠️ 中 | 有 `.env` 环境变量支持，但 fallback 到硬编码 |
| `frontend/src/hooks/useSSE.ts:14` | `http://localhost:8888/api/v1` | ⚠️ 中 | 有 `.env` 环境变量支持，但 fallback 到硬编码 |
| `frontend/src/pages/TaskControl.tsx:8` | `http://localhost:8888/api/v1` | ⚠️ 中 | 有 `.env` 环境变量支持，但 fallback 到硬编码 |
| `frontend/package.json:7` | `port 3000` | ✅ 低 | 开发配置，可通过命令行参数覆盖 |

**前端现有环境变量配置：**
- 文件：`frontend/.env`
- 内容：`VITE_API_BASE_URL=http://localhost:8888/api/v1`

### 后端

| 文件位置 | 硬编码内容 | 严重程度 | 说明 |
|---------|-----------|---------|------|
| `backend/app/main.py:59-60` | `http://localhost:8000/docs` | ✅ 低 | 仅日志输出，实际端口由 uvicorn 命令行决定 |
| `backend/app/main.py:194` | `port=8000` | ✅ 低 | `if __name__ == "__main__"` 块，开发启动用 |
| `backend/app/core/config.py:28` | `CORS_ORIGINS` 包含 `http://localhost:3000` | ⚠️ 中 | 已配置 `"*"` 通配符作为后备 |

**后端现有环境变量配置：**
- 文件：`backend/.env`
- 支持通过环境变量覆盖 `config.py` 中的所有配置

---

## 结论

### ✅ 做得好的地方

1. **前后端都有 `.env` 环境变量文件**
2. **代码中使用 `import.meta.env.VITE_API_BASE_URL` 或 `os.getenv()` 读取环境变量**
3. **有合理的 fallback 机制**

### ⚠️ 需要改进的地方

1. **前端代码中有 3 处 API 地址的硬编码 fallback**
   - 建议：移除 fallback，统一使用环境变量
   - 文件：`api.ts`, `useSSE.ts`, `TaskControl.tsx`

2. **后端 CORS 配置中的 localhost:3000**
   - 建议：使用环境变量 `FRONTEND_URL` 配置
   - 文件：`backend/app/core/config.py`

3. **后端启动日志显示错误的端口（8000 vs 实际 8888）**
   - 文件：`backend/app/main.py:59-60`
   - 建议：从环境变量读取实际端口

---

## 建议改进方案

### 方案一：最小改动（推荐）

**前端 `api.ts`、`useSSE.ts`、`TaskControl.tsx` 中移除 fallback：**

```typescript
// 改为强制要求环境变量
const API_BASE_URL = import.meta.env.VITE_API_BASE_URL;
if (!API_BASE_URL) {
  throw new Error("VITE_API_BASE_URL 环境变量未设置");
}
```

**后端 `core/config.py` 中 CORS 使用环境变量：**

```python
FRONTEND_URL: str = "http://localhost:3000"
CORS_ORIGINS: list[str] = ["http://localhost:3000", FRONTEND_URL, "*"]
```

### 方案二：完整配置化

**后端添加端口环境变量：**

```python
# config.py
SERVER_PORT: int = 8000
```

**修改 `main.py` 日志输出：**

```python
print(f"📚 API Documentation: http://localhost:{settings.SERVER_PORT}{settings.API_V1_STR}/docs")
```

---

## 当前实际使用端口

| 服务 | 配置端口 | 实际运行端口 |
|-----|---------|------------|
| 前端 | 3000 (package.json) | 3000 |
| 后端 | 8000 (main.py fallback) | 8888 (命令行参数) |

**注意：** 后端实际通过 `uvicorn --port 8888` 启动，main.py 中的 8000 仅作为开发启动的默认值。
