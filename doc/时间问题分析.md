# 执行日志时间问题分析

## 问题描述
执行日志的开始时间、结束时间与通过 webhook 传入的时间不一致，怀疑是时区问题。

---

## 代码分析

### 1. 后端 webhook 传入时间

**文件**: `backend/app/api/v1/webhook.py`

```python
# 第 192-203 行
log = await log_service.create_log(
    ...
    start_time=payload.start_time,   # 字符串格式
    end_time=payload.end_time,       # 字符串格式
    ...
)
```

### 2. 后端时间处理逻辑

**文件**: `backend/app/repositories/log_repository.py`

```python
# 第 218-236 行
if isinstance(start_time, str):
    start_time_str = start_time.replace("Z", "+00:00")
    try:
        start_time = datetime.fromisoformat(start_time_str)
    except ValueError:
        # 尝试简单格式 (YYYY-MM-DD HH:MM:SS)
        start_time = datetime.strptime(start_time[:19], "%Y-%m-%d %H:%M:%S")
    # 北京时间转 UTC (减去 8 小时)
    start_time = start_time - timedelta(hours=8)
```

**问题**：代码假设传入的时间是北京时间（UTC+8），然后减去 8 小时存储。

### 3. 前端时间展示

**文件**: `frontend/src/pages/ExecutionLogs.tsx`

```javascript
// 第 140-152 行
const formatTime = (timeString: string) => {
  try {
    const date = new Date(timeString);
    return date.toLocaleString('zh-CN', {
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  } catch {
    return timeString;
  }
};
```

**问题**：前端使用 `new Date()` 解析，然后根据浏览器时区展示。

---

## 时区问题分析

### 场景分析

| 步骤 | 操作 | 结果 |
|------|------|------|
| 1 | ShadowBot 传入时间 | `2026-01-29 09:18:14`（假设是北京时间） |
| 2 | 后端解析时间 | `datetime(2026, 1, 29, 9, 18, 14)` |
| 3 | 后端减 8 小时 | `datetime(2026, 1, 29, 1, 18, 14)` |
| 4 | 存储到数据库 | `2026-01-29 01:18:14`（UTC） |
| 5 | 前端解析 | `new Date("2026-01-29 01:18:14")` |
| 6 | 浏览器时区展示（UTC+8） | `2026-01-29 09:18:14` |

**结果**：如果浏览器时区是北京时间，最终展示应该是正确的。

### 潜在问题

1. **传入时间格式不明确**
   - 传入的时间 `2026-01-29 09:18:14` 没有时区信息
   - Python 的 `datetime.strptime` 默认当作**本地时间**处理
   - 如果服务器时区不是北京时间，转换会出错

2. **数据库存储格式问题**
   - SQLite 以 TEXT 格式存储时间
   - 存储的是 datetime 对象的字符串表示

---

## 解决方案

### 方案 A：统一使用 UTC 时间（推荐）

**优点**：
- 符合最佳实践
- 避免时区混乱

**实现**：
```python
# 修改 log_repository.py

# 方式 1：直接存储 UTC，不做转换
if isinstance(start_time, str):
    start_time_str = start_time.replace("Z", "+00:00")
    try:
        start_time = datetime.fromisoformat(start_time_str)
    except ValueError:
        start_time = datetime.strptime(start_time[:19], "%Y-%m-%d %H:%M:%S")

# 方式 2：让 ShadowBot 传入 UTC 时间
# webhook 接收的格式不变，但要求 ShadowBot 传入 UTC 时间
```

### 方案 B：统一使用北京时间

**优点**：
- 对于国内应用更直观
- 简化处理

**实现**：
```python
# 修改 log_repository.py

# 不做时区转换，直接存储
if isinstance(start_time, str):
    start_time_str = start_time.replace("Z", "+00:00")
    try:
        start_time = datetime.fromisoformat(start_time_str)
    except ValueError:
        start_time = datetime.strptime(start_time[:19], "%Y-%m-%d %H:%M:%S")
    # 注释掉减 8 小时的代码
    # start_time = start_time - timedelta(hours=8)
```

### 方案 C：明确时区标准

**在 webhook 中明确时间格式要求**：

```python
class WebhookExecutionComplete(BaseModel):
    start_time: str = Field(
        ...,
        description="开始时间 (UTC 格式，如: 2026-01-29T01:18:14Z 或 2026-01-29 01:18:14)"
    )
```

---

## 建议

**推荐方案 A（统一使用 UTC）**：

1. 后端不做时区转换，假设传入的是 UTC 时间
2. 前端展示时，根据用户时区转换
3. 数据库存储 UTC 时间

**修改文件**：`backend/app/repositories/log_repository.py`

```python
# 第 217-236 行，注释掉时区转换

if isinstance(start_time, str):
    start_time_str = start_time.replace("Z", "+00:00")
    try:
        start_time = datetime.fromisoformat(start_time_str)
    except ValueError:
        # 尝试简单格式 (YYYY-MM-DD HH:MM:SS)
        start_time = datetime.strptime(start_time[:19], "%Y-%m-%d %H:%M:%S")
    # 【删除】北京时间转 UTC (减去 8 小时)
    # start_time = start_time - timedelta(hours=8)

if isinstance(end_time, str):
    end_time_str = end_time.replace("Z", "+00:00")
    try:
        end_time = datetime.fromisoformat(end_time_str)
    except ValueError:
        end_time = datetime.strptime(end_time[:19], "%Y-%m-%d %H:%M:%S")
    # 【删除】北京时间转 UTC (减去 8 小时)
    # end_time = end_time - timedelta(hours=8)
```

---

## 验证方法

1. 发送 webhook 请求，传入明确的 UTC 时间
2. 检查数据库存储的时间
3. 检查前端展示的时间

```bash
# 测试 UTC 时间
curl -X POST http://localhost:8000/api/v1/webhook/execution-complete \
  -H "Content-Type: application/json" \
  -d '{
    "shadow_bot_account": "redballoon",
    "app_name": "测试应用",
    "status": "completed",
    "start_time": "2026-01-29T01:18:14Z",
    "end_time": "2026-01-29T01:19:14Z",
    "duration_seconds": 60
  }'
```

---

## 时间线

| 时间点 | 操作 |
|--------|------|
| 2026-01-30 | 发现问题，开始分析 |
| - | 待确认方案后实施修复 |
