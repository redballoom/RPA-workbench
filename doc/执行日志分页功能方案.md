# 执行日志分页功能优化方案

> 2026-02-02

## 需求

优化"执行日志"页面，增加分页功能，允许用户设置每页显示 10 条、50 条、100 条记录。

## 现状分析

### 当前问题

1. **前端硬编码分页大小**：`ExecutionLogs.tsx` 中 `loadLogs()` 固定使用 `page_size: 100`
2. **缺少分页控件**：没有首页/上一页/页码/下一页/末页导航
3. **缺少每页数量选择器**：用户无法自定义每页显示数量
4. **前端冗余过滤**：代码中仍有前端过滤逻辑，但后端已支持分页

### 现有支持（后端已实现）

- **API 支持**：`/api/v1/logs` 已支持 `page` 和 `page_size` 参数
- **响应结构**：返回 `total`、`page`、`page_size`、`total_pages` 分页信息
- **page_size 范围**：1-100

## 方案设计

### 前端修改

#### 1. 新增状态变量

```typescript
// 分页状态
const [currentPage, setCurrentPage] = useState(1);
const [pageSize, setPageSize] = useState(20);
const [total, setTotal] = useState(0);
const [totalPages, setTotalPages] = useState(0);

// 可选的每页数量选项
const pageSizeOptions = [
  { label: '10 条/页', value: 10 },
  { label: '50 条/页', value: 50 },
  { label: '100 条/页', value: 100 },
];
```

#### 2. 修改 loadLogs 函数

```typescript
const loadLogs = async () => {
  try {
    setLoading(true);
    const response = await logsApi.getLogs({
      search: searchTerm,
      status: statusFilter !== "all" ? statusFilter : undefined,
      page: currentPage,
      page_size: pageSize,
      sort_by: sortBy,
      order: sortOrder,
    });
    setLogs(response.items || []);
    setTotal(response.total || 0);
    setTotalPages(response.total_pages || 0);
  } catch (error) {
    // 错误处理
  } finally {
    setLoading(false);
  }
};
```

#### 3. 添加分页控件 UI

位置：表格下方，模态框之外

```tsx
<div className="flex items-center justify-between px-4 py-3 border-t border-slate-200 dark:border-slate-700">
  {/* 每页数量选择器 */}
  <div className="flex items-center space-x-2">
    <span className="text-sm text-slate-500 dark:text-slate-400">每页</span>
    <select
      value={pageSize}
      onChange={(e) => {
        setPageSize(Number(e.target.value));
        setCurrentPage(1); // 重置到第一页
        loadLogs();
      }}
      className="..."
    >
      <option value={10}>10</option>
      <option value={50}>50</option>
      <option value={100}>100</option>
    </select>
    <span className="text-sm text-slate-500 dark:text-slate-400">条</span>
  </div>

  {/* 分页信息 */}
  <div className="text-sm text-slate-500 dark:text-slate-400">
    共 {total} 条记录，第 {currentPage}/{totalPages} 页
  </div>

  {/* 页码导航 */}
  <div className="flex items-center space-x-1">
    <button
      onClick={() => goToPage(1)}
      disabled={currentPage === 1}
      className="..."
    >
      首页
    </button>
    <button
      onClick={() => goToPage(currentPage - 1)}
      disabled={currentPage === 1}
      className="..."
    >
      上一页
    </button>
    {/* 页码按钮显示逻辑：最多显示 5 个页码 */}
    {renderPageNumbers()}
    <button
      onClick={() => goToPage(currentPage + 1)}
      disabled={currentPage === totalPages}
      className="..."
    >
      下一页
    </button>
    <button
      onClick={() => goToPage(totalPages)}
      disabled={currentPage === totalPages}
      className="..."
    >
      末页
    </button>
  </div>
</div>
```

#### 4. 移除前端过滤

当前代码中 `filteredLogs` 是前端过滤，应移除，改为使用后端分页数据。

### 修改文件

| 文件 | 修改内容 |
|-----|---------|
| `frontend/src/pages/ExecutionLogs.tsx` | 添加分页状态、分页控件 UI、修改 loadLogs 函数 |

## 分页控件设计

### 布局

```
┌─────────────────────────────────────────────────────────────────┐
│ [每页 10▼] 条                    共 100 条记录，第 1/10 页       │
│                                                                 │
│                    首页  上一页  1  2  3  4  5  下一页  末页      │
└─────────────────────────────────────────────────────────────────┘
```

### 页码显示逻辑

- 当前页前后各显示 2 页（共 5 页）
- 首尾页码始终显示
- 中间页码用省略号表示（如 1 2 ... 9 10）

## 验证测试

1. 启动前端开发服务器 `cd frontend && pvnpm dev`
2. 访问执行日志页面
3. 验证：
   - 每页数量选择器可用
   - 切换每页数量后正确加载数据
   - 分页导航按钮正常工作
   - 数据显示与分页信息一致

## 执行状态

- [x] 编写方案文档
- [ ] 用户确认
- [ ] 代码实现
- [ ] 测试验证
