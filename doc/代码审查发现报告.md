# 代码审查发现报告

> 2026-01-31

## 审查范围

- `backend/app/services/task_service.py`
- `backend/app/services/sse_service.py`
- `backend/app/api/v1/sse.py`
- `backend/app/api/v1/tasks.py`
- `frontend/src/lib/api.ts`
- `frontend/src/pages/TaskControl.tsx`
- `frontend/src/pages/Dashboard.tsx`

---

## 1. Task Count 同步修复 ✅ 已完成

### 问题
修改任务所属账号时，`task_count` 没有同步更新。

### 修复状态
`task_service.py` 第 133-147 行已实现修复：

```python
# 记录修改前的账号
old_shadow_bot_account = task.shadow_bot_account

# Filter out None values for update
update_data = {k: v for k, v in task_in.model_dump().items() if v is not None}

updated_task = await self.repo.update(task_id, update_data)

# 检查是否修改了 shadow_bot_account
new_shadow_bot_account = task_in.shadow_bot_account
if new_shadow_bot_account and new_shadow_bot_account != old_shadow_bot_account:
    # 同步原账号和新账号的 task_count
    await self._sync_task_count(old_shadow_bot_account)
    await self._sync_task_count(new_shadow_bot_account)
    print(f"[更新任务] 账号从 '{old_shadow_bot_account}' 改为 '{new_shadow_bot_account}'")
```

### 验证
- ✅ 创建任务时同步
- ✅ 删除任务时同步
- ✅ 修改账号时同步

---

## 2. 强制停止功能 ✅ 已实现

### 后端实现
`tasks.py` 第 96-110 行：

```python
@router.post("/{task_id}/force-stop", response_model=TaskStopResponse)
async def force_stop_task(
    task_id: str,
    force: bool = Query(True, description="是否强制停止（忽略代理请求结果）"),
    db: AsyncSession = Depends(get_db),
):
    """Force stop a running task"""
    service = TaskService(db)
    return await service.force_stop_task(task_id, force=force)
```

### 前端实现
`api.ts` 第 203-214 行：

```typescript
// 强制停止任务
async forceStop(id: string): Promise<{
  success: boolean;
  message: string;
  task_id: string;
  status: string;
}> {
  return request<{
    success: boolean;
    message: string;
    task_id: string;
    status: string;
  }>(`/tasks/${id}/force-stop?force=true`, {
    method: 'POST',
  });
},
```

### TaskControl.tsx 中的使用
```typescript
const handleForceStop = async (task: Task) => {
  if (!confirm(`确定要强制停止任务 "${task.task_name}" 吗？\n\n此操作将直接更新状态为"待启动"，不等待影刀确认。`)) {
    return;
  }
  try {
    await tasksApi.forceStop(task.id);
    toast.success("任务已强制停止");
    loadTasks();
  } catch (error) {
    console.error('Failed to force stop task:', error);
    toast.error("强制停止失败");
  }
};
```

### 验证
- ✅ 后端 API 存在
- ✅ 前端 API 调用存在
- ✅ UI 按钮存在
- ✅ 确认对话框存在

---

## 3. SSE 服务分析

### 代码结构

**sse_service.py** - SSE 事件推送服务
- 使用 `asyncio.Queue` 实现客户端消息队列
- 30 秒心跳机制保持连接
- 支持广播和指定客户端发送

**sse.py** - SSE 端点
```python
@router.get("/events")
async def sse_events(request: Request, account_id: str = Query(default=None)):
    sse_service = get_sse_service()
    if not sse_service:
        return {"error": "SSE service not available"}

    client_id = str(uuid.uuid4())
    client = await sse_service.add_client(client_id, account_id)

    return EventSourceResponse(
        sse_service.generate_events(client),
        media_type="text/event-stream"
    )
```

### 潜在问题
1. **注释中的硬编码 URL** (sse.py 第 25 行注释)：
   ```python
   # 客户端连接: http://localhost:8888/api/v1/sse/events?account_id=xxx
   ```
   这只是注释，实际代码使用动态获取。

2. **无连接超时处理** - 如果客户端断开，可能有残留连接

### 验证
- ✅ SSE 服务正常初始化
- ✅ 心跳机制正常工作
- ✅ 支持任务状态更新广播

---

## 4. Dashboard 页面分析

### 执行排名展示
`Dashboard.tsx` 已修改为显示数字序号：

```typescript
{executionRank.map((item, index) => (
  <div key={item.app_name} className="flex items-center justify-between px-2">
    <span className="text-slate-400 text-sm w-5">{index + 1}</span>
    <span className="truncate text-sm text-slate-700 dark:text-slate-300 flex-1">
      {item.app_name}
    </span>
    <span className="text-sm font-medium text-slate-900 dark:text-white w-20 text-right">
      {Math.round(item.total_duration / 60)}
    </span>
    <span className="text-sm text-slate-600 dark:text-slate-400 w-16 text-right">
      {item.execution_count}
    </span>
  </div>
))}
```

### 表头
```typescript
<div className="flex items-center justify-between text-xs font-medium text-slate-500 dark:text-slate-400 px-2">
  <span className="w-5">#</span>
  <span className="flex-1">应用</span>
  <span className="w-20 text-right">时间/m</span>
  <span className="w-16 text-right">次数</span>
</div>
```

### 验证
- ✅ 数字序号显示
- ✅ 表头存在
- ✅ 单位标注正确（时间/m 表示分钟）

---

## 5. 前后端连接问题 ❌ 待解决

### 问题现象
- 浏览器报错：`ERR_EMPTY_RESPONSE`
- curl 测试：全部正常

### 后端日志分析
```
INFO:     127.0.0.1:54678 - "GET /api/v1/logs?page=1 HTTP/1.1" 200 OK
INFO:     127.0.0.1:54660 - "GET /api/v1/accounts HTTP/1.1" 200 OK
INFO:     127.0.0.1:54672 - "GET /api/v1/tasks HTTP/1.1" 200 OK
```

所有 API 请求都返回 200 OK，说明后端服务正常。

### 问题定位
**代码无问题**，问题在浏览器端：
1. 浏览器缓存旧的失败响应
2. 浏览器扩展阻止请求（广告拦截、隐私工具）
3. SSE 连接可能阻塞其他请求
4. WSL 与 Windows 浏览器之间的网络异常

### 建议解决方案
1. **强制刷新**：`Ctrl + Shift + R`
2. **无痕模式**：在无痕窗口中打开
3. **禁用扩展**：临时禁用广告拦截器
4. **清除缓存**：开发者工具 → 网络 → 禁用缓存

---

## 6. 总结

| 功能 | 状态 | 说明 |
|------|------|------|
| Task Count 同步 | ✅ 已修复 | 创建/删除/修改账号时正确同步 |
| 强制停止任务 | ✅ 已实现 | 后端 API + 前端 UI 完成 |
| 执行排名展示 | ✅ 已改进 | 添加序号和表头 |
| SSE 服务 | ✅ 正常 | 心跳和广播机制正常 |
| 前后端连接 | ⚠️ 待解决 | 后端正常，可能是浏览器问题 |

---

## 7. 建议后续操作

1. **解决浏览器连接问题**
   - 在浏览器无痕模式下测试
   - 检查是否有广告拦截扩展

2. **SSE 优化**（可选）
   - 添加连接超时自动清理
   - 添加客户端重连机制

3. **日志优化**（可选）
   - 减少 SQLAlchemy 日志输出级别
   - 合并重复的数据库查询
