# RPA-workbench 后端项目架构文档

> 2026-02-02 | 基于最新代码

---

## 1. 项目概述

**RPA-workbench** 是一个机器人流程自动化（RPA）管理平台的后端服务，用于提供 REST API 和实时通信，支持影刀自动化任务的监控与控制。

### 核心功能

- 账号管理：影刀账号的 CRUD、状态同步
- 任务管理：任务创建、启动、停止、强制停止
- 执行日志：记录和查询任务执行历史
- 仪表盘统计：性能趋势、执行排行、数据汇总
- Webhook 回调：接收影刀执行状态更新
- 实时推送：SSE 事件流推送状态变更

---

## 2. 技术栈

| 技术 | 版本/用途 |
|------|-----------|
| Python | 3.10+ |
| FastAPI | 异步 Web 框架 |
| SQLAlchemy | ORM（异步） |
| aiosqlite | 异步 SQLite 驱动 |
| Pydantic v2 | 数据验证和序列化 |
| Uvicorn | ASGI 服务器 |
| python-jose | JWT 认证 |
| passlib | 密码加密 |
| alembic | 数据库迁移 |

---

## 3. 目录结构

```
backend/
├── app/
│   ├── __init__.py
│   ├── main.py                    # FastAPI 应用入口
│   │
│   ├── api/
│   │   ├── __init__.py
│   │   └── v1/                    # API 路由
│   │       ├── __init__.py
│   │       ├── accounts.py        # 账号管理 API
│   │       ├── tasks.py           # 任务管理 API
│   │       ├── logs.py            # 执行日志 API
│   │       ├── dashboard.py       # 仪表盘 API
│   │       ├── webhook.py         # 影刀 Webhook
│   │       ├── sse.py             # SSE 实时推送
│   │       └── resources.py       # 资源文件服务
│   │
│   ├── core/                      # 核心配置
│   │   ├── __init__.py
│   │   ├── config.py              # 应用配置
│   │   ├── database.py            # 数据库配置
│   │   └── security.py            # 安全配置
│   │
│   ├── models/                    # SQLAlchemy 数据模型
│   │   ├── __init__.py
│   │   ├── account.py             # 账号模型
│   │   ├── task.py                # 任务模型
│   │   ├── execution_log.py       # 执行日志模型
│   │   └── user.py                # 用户模型
│   │
│   ├── schemas/                   # Pydantic 验证 schemas
│   │   ├── __init__.py
│   │   ├── account.py             # 账号 schemas
│   │   ├── task.py                # 任务 schemas
│   │   ├── execution_log.py       # 执行日志 schemas
│   │   ├── user.py                # 用户 schemas
│   │   └── common.py              # 通用 schemas
│   │
│   ├── services/                  # 业务逻辑层
│   │   ├── __init__.py
│   │   ├── account_service.py     # 账号业务逻辑
│   │   ├── task_service.py        # 任务业务逻辑
│   │   ├── execution_log_service.py # 日志业务逻辑
│   │   ├── dashboard_service.py   # 仪表盘统计
│   │   └── sse_service.py         # SSE 实时推送
│   │
│   ├── repositories/              # 数据访问层
│   │   ├── __init__.py
│   │   ├── base.py                # 基础仓库类
│   │   ├── account_repository.py
│   │   ├── task_repository.py
│   │   └── log_repository.py
│   │
│   └── utils/
│       └── __init__.py
│
├── tests/                         # 测试文件
├── alembic/                       # 数据库迁移
├── requirements.txt               # Python 依赖
├── pyproject.toml                 # 项目配置
├── alembic.ini                    # 迁移配置
├── pytest.ini                     # 测试配置
└── rpa_app.db                     # SQLite 数据库文件
```

---

## 4. API 端点完整列表

### 4.1 账号管理 (`/api/v1/accounts`)

| 方法 | 路径 | 功能 |
|------|------|------|
| GET | `/api/v1/accounts` | 账号列表（分页、搜索、状态筛选） |
| GET | `/api/v1/accounts/{id}` | 获取单个账号 |
| POST | `/api/v1/accounts` | 创建账号 |
| PUT | `/api/v1/accounts/{id}` | 更新账号 |
| DELETE | `/api/v1/accounts/{id}` | 删除账号 |

### 4.2 任务管理 (`/api/v1/tasks`)

| 方法 | 路径 | 功能 |
|------|------|------|
| GET | `/api/v1/tasks` | 任务列表（分页、搜索） |
| GET | `/api/v1/tasks/{id}` | 获取单个任务 |
| POST | `/api/v1/tasks` | 创建任务 |
| PUT | `/api/v1/tasks/{id}` | 更新任务 |
| DELETE | `/api/v1/tasks/{id}` | 删除任务 |
| POST | `/api/v1/tasks/{id}/start` | 启动任务 |
| POST | `/api/v1/tasks/{id}/stop` | 停止任务 |
| POST | `/api/v1/tasks/{id}/force-stop` | 强制停止 |

### 4.3 执行日志 (`/api/v1/logs`)

| 方法 | 路径 | 功能 |
|------|------|------|
| GET | `/api/v1/logs` | 日志列表（分页、搜索、筛选） |
| GET | `/api/v1/logs/export` | 导出 CSV |
| GET | `/api/v1/logs/{id}` | 获取单个日志 |

### 4.4 仪表盘 (`/api/v1/dashboard`)

| 方法 | 路径 | 功能 |
|------|------|------|
| GET | `/api/v1/dashboard/stats` | 统计数据 |
| GET | `/api/v1/dashboard/performance` | 性能趋势 |
| GET | `/api/v1/dashboard/execution-rank` | 执行时长排行 |

### 4.5 Webhook (`/api/v1/webhook`)

| 方法 | 路径 | 功能 |
|------|------|------|
| POST | `/api/v1/webhook/confirm` | 确认任务执行 |
| POST | `/api/v1/webhook/execution-complete` | 执行完成回调 |
| POST | `/api/v1/webhook/heartbeat` | 心跳保活 |

### 4.6 SSE 实时推送 (`/api/v1/sse`)

| 方法 | 路径 | 功能 |
|------|------|------|
| GET | `/api/v1/sse/events` | SSE 事件流 |
| GET | `/api/v1/sse/status` | SSE 服务状态 |

### 4.7 资源服务 (`/api/v1/resources`)

| 方法 | 路径 | 功能 |
|------|------|------|
| GET | `/api/v1/resources/{path:match}` | 静态资源服务 |
| GET | `/api/v1/resources/proxy` | 云端资源代理 |
| GET | `/api/v1/resources/proxy/download` | 云端资源下载 |
| GET | `/api/v1/resources/proxy/intranet` | 内网穿透代理 |
| POST | `/api/v1/resources/upload/config` | 上传任务配置 |
| POST | `/api/v1/resources/config/get` | 获取任务配置 |

---

## 5. 数据模型

### 5.1 Account（账号）

```python
class Account(Base):
    id: str                          # UUID
    shadow_bot_account: str          # 影刀账号名
    host_ip: str                     # 主机 IP
    port: int                        # 连接端口
    status: str                      # pending/completed/failed/running
    recent_app: str | None           # 最近运行的应用
    end_time: datetime | None        # 结束时间
    task_control: str                # 控制标识（唯一）
    task_count: int                  # 关联任务数
    created_at: datetime
    updated_at: datetime
```

**task_control 格式**：`{shadow_bot_account}-{host_ip}:{port}`

### 5.2 Task（任务）

```python
class Task(Base):
    id: str                          # UUID
    task_name: str                   # 任务名称
    shadow_bot_account: str          # 关联账号
    host_ip: str                     # 主机 IP
    app_name: str                    # 应用名称
    last_run_time: datetime | None   # 最后运行时间
    status: str                      # pending/running
    config_file: bool                # 启用配置文件
    config_info: bool                # 启用配置信息
    config_file_path: str | None     # OSS URL
    config_json: str | None          # JSON 配置
    trigger_time: datetime | None    # 触发时间
    created_at: datetime
    updated_at: datetime
```

### 5.3 ExecutionLog（执行日志）

```python
class ExecutionLog(Base):
    id: str                          # UUID
    text: str                        # 日志摘要
    app_name: str                    # 应用名称
    shadow_bot_account: str          # 影刀账号
    status: str                      # completed/failed
    start_time: datetime             # 开始时间
    end_time: datetime               # 结束时间
    duration: int                    # 执行时长（秒）
    host_ip: str                     # 主机 IP
    log_info: bool                   # 是否有日志
    screenshot: bool                 # 是否有截图
    screenshot_path: str | None      # 截图路径/URL
    log_content: str | None          # 日志内容
    created_at: datetime
```

### 5.4 User（用户）

```python
class User(Base):
    id: str                          # UUID
    username: str                    # 用户名（唯一）
    email: str | None                # 邮箱
    hashed_password: str             # 加密密码
    role: str                        # admin/user
    is_active: bool                  # 是否激活
    created_at: datetime
    updated_at: datetime
```

---

## 6. 服务层业务逻辑

### 6.1 AccountService

**主要功能**：
- 账号 CRUD 操作
- 自动生成 `task_control`（格式：`account-ip:port`）
- 任务数量统计（`_sync_task_count`）
- 状态管理（pending/completed/failed/running）

### 6.2 TaskService

**主要功能**：
- 任务 CRUD 操作
- **内网穿透控制**：发送 HTTP 请求到影刀代理
- **强制停止**：直接更新状态，不等待回调
- 任务状态同步到账号
- 任务数量统计

**内网穿透配置**：
```python
INTRANET_PROXY_BASE_URL = "https://qn-v.xf5920.cn/yingdao"
```

### 6.3 ExecutionLogService

**主要功能**：
- 执行日志 CRUD
- 统计数据计算（成功率、日均执行）
- CSV 导出
- 执行时长排行榜

### 6.4 DashboardService

**主要功能**：
- 聚合各服务统计数据
- 性能趋势分析（按日期分组）
- 时区支持（UTC/Asia/Shanghai）

### 6.5 SSEService

**主要功能**：
- Server-Sent Events 实时推送
- 多客户端连接管理
- 事件类型：
  - `log_created`：新日志创建
  - `account_updated`：账号更新
  - `task_updated`：任务更新
  - `heartbeat`：心跳（30秒）

---

## 7. 数据库配置

### 7.1 连接配置

文件：`backend/app/core/database.py`

```python
DATABASE_URL = "sqlite+aiosqlite:///./rpa_app.db"

# 异步引擎
engine = create_async_engine(
    DATABASE_URL,
    echo=False,
    pool_pre_ping=True,
)

# 异步会话
AsyncSessionLocal = sessionmaker(
    engine,
    class_=AsyncSession,
    expire_on_commit=False,
)
```

### 7.2 获取数据库会话

```python
async def get_db():
    async with AsyncSessionLocal() as session:
        yield session
```

---

## 8. CORS 配置

文件：`backend/app/core/config.py`

```python
CORS_ORIGINS = [
    "http://localhost:3000",
    "http://127.0.0.1:3000",
    "*",  # 允许局域网访问
]
```

---

## 9. 启动配置

### 9.1 启动命令

```bash
# 开发模式（自动重载）
uvicorn app.main:app --reload --host 0.0.0.0 --port 8888

# 生产模式
uvicorn app.main:app --host 0.0.0.0 --port 8888
```

### 9.2 start.sh 配置

```bash
BACKEND_PORT=8888
FRONTEND_PORT=3000
```

---

## 10. Webhook 回调流程

```
影刀执行完成
       │
       ▼
POST /api/v1/webhook/execution-complete
       │
       ├─▶ 创建 ExecutionLog
       │
       ├─▶ 更新 Task 状态
       │
       ├─▶ 更新 Account 状态
       │
       └─▶ 推送 SSE 事件
```

---

## 11. SSE 事件流程

```
浏览器连接
   │
   ▼
GET /api/v1/sse/events?account_id=xxx
   │
   ▼
EventSourceResponse 生成事件流
   │
   ├─▶ 任务状态变更 → task_updated
   ├─▶ 账号状态变更 → account_updated
   ├─▶ 新日志创建   → log_created
   └─▶ 心跳        → heartbeat (30秒)
```

---

## 12. 注意事项

1. **异步操作**：所有数据库操作使用 `async/await`
2. **命名规范**：API 使用 `snake_case`，前端类型定义与其一致
3. **资源代理**：云端资源通过后端 `/resources/proxy` 代理访问
4. **WSL 访问**：需要配置 Windows 端口转发才能从外部访问
5. **数据库文件**：`backend/rpa_app.db`（SQLite）

---

## 13. API 文档

启动服务后访问：
- Swagger UI：`http://localhost:8888/docs`
- ReDoc：`http://localhost:8888/redoc`
