# RPA-workbench 前端项目架构文档

> 2026-02-02 | 基于最新代码

---

## 1. 项目概述

**RPA-workbench** 是一个机器人流程自动化（RPA）管理平台的前端应用，用于监控和控制影刀自动化任务。

### 核心功能

- 仪表盘：系统概览、统计数据、性能趋势、任务执行排行
- 账号管理：影刀账号的增删改查、状态同步
- 任务控制：任务启动、停止、强制停止、配置管理
- 执行日志：查看执行记录、截图、日志导出

---

## 2. 技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| React | 18.3.1 | UI 框架 |
| TypeScript | 5.7.2 | 类型安全 |
| Vite | 6.2.0 | 构建工具 |
| React Router | 7.3.0 | 路由管理 |
| Tailwind CSS | 3.4.17 | 样式框架 |
| Recharts | 2.15.1 | 图表库 |
| Sonner | 2.0.2 | Toast 通知 |
| Framer Motion | 12.9.2 | 动画效果 |
| Lucide React | 0.447.0 | 图标库 |

---

## 3. 目录结构

```
frontend/src/
├── main.tsx                    # 应用入口
├── App.tsx                     # 主应用组件（路由配置）
├── index.css                   # 全局样式
├── vite-env.d.ts              # Vite 类型定义
│
├── components/                 # 可复用组件
│   ├── Layout.tsx             # 主布局组件（侧边栏 + 内容区）
│   ├── Sidebar.tsx            # 导航侧边栏
│   ├── StatusBadge.tsx        # 状态徽章（completed/pending/running/failed）
│   ├── ActionButton.tsx       # 通用按钮（4种样式）
│   └── Empty.tsx              # 空状态组件
│
├── pages/                      # 页面组件
│   ├── Dashboard.tsx          # 仪表盘（首页）
│   ├── AccountManagement.tsx  # 账号管理
│   ├── TaskControl.tsx        # 任务控制
│   ├── ExecutionLogs.tsx      # 执行日志
│   └── Home.tsx               # 首页重定向
│
├── contexts/                   # React Context
│   └── authContext.ts         # 认证状态管理
│
├── hooks/                      # 自定义 Hooks
│   ├── useTheme.ts            # 主题管理（明暗模式）
│   └── useSSE.ts              # SSE 实时通信
│
└── lib/                        # 工具库
    ├── api.ts                 # API 客户端（核心）
    └── utils.ts               # 工具函数
```

---

## 4. 页面组件详解

### 4.1 Dashboard.tsx

**功能**：系统仪表盘，显示统计数据和性能指标

**主要内容**：
- 统计数据卡片（账号数、任务数、执行日志数）
- 性能趋势图表（按日期统计执行时长）
- 任务执行时长排行榜（Top 10）

**交互**：
- 实时 SSE 更新
- 支持时间范围筛选

### 4.2 AccountManagement.tsx

**功能**：影刀账号管理

**主要操作**：
- 账号列表（分页、搜索）
- 创建账号（自动生成 task_control）
- 编辑账号
- 删除账号
- 查看关联任务数

**状态徽章**：
- `pending`：待启动
- `running`：运行中
- `completed`：已完成
- `failed`：失败

### 4.3 TaskControl.tsx

**功能**：任务控制和管理

**主要操作**：
- 任务列表（分页、搜索、状态筛选）
- 创建任务
- 编辑任务
- 删除任务
- 启动任务（POST /tasks/{id}/start）
- 停止任务（POST /tasks/{id}/stop）
- 强制停止（直接更新状态，不等待回调）

**配置管理**：
- 配置文件开关（config_file）
- 配置信息开关（config_info）
- 支持 JSON 配置编辑

### 4.4 ExecutionLogs.tsx

**功能**：执行日志查看和管理

**主要操作**：
- 日志列表（分页、搜索、状态筛选）
- 查看截图
- 查看详细日志内容
- 导出 CSV
- 下载截图和日志文件

---

## 5. API 集成

### 5.1 API 客户端结构

文件：`frontend/src/lib/api.ts`

**配置**：
```typescript
const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:8888/api/v1';
```

**6 大 API 模块**：

| 模块 | 端点数 | 主要功能 |
|------|--------|----------|
| `accountsApi` | 5 | 账号 CRUD、统计 |
| `tasksApi` | 7 | 任务 CRUD、启动/停止/强制停止 |
| `logsApi` | 2 | 日志查询、导出 |
| `dashboardApi` | 3 | 统计、趋势、排行 |
| `webhookApi` | 2 | Webhook 回调 |
| `systemApi` | 2 | 服务状态 |

### 5.2 主要 API 端点

#### 账号管理
```typescript
GET  /accounts              // 列表（分页、搜索）
GET  /accounts/{id}         // 详情
POST /accounts              // 创建
PUT  /accounts/{id}         // 更新
DELETE /accounts/{id}       // 删除
```

#### 任务管理
```typescript
GET  /tasks                 // 列表
GET  /tasks/{id}            // 详情
POST /tasks                 // 创建
PUT  /tasks/{id}            // 更新
DELETE /tasks/{id}          // 删除
POST /tasks/{id}/start      // 启动
POST /tasks/{id}/stop       // 停止
POST /tasks/{id}/force-stop // 强制停止
```

#### 执行日志
```typescript
GET  /logs                  // 列表（筛选、搜索）
GET  /logs/export           // 导出 CSV
```

#### 仪表盘
```typescript
GET  /dashboard/stats       // 统计数据
GET  /dashboard/performance // 性能趋势
GET  /dashboard/execution-rank // 执行排行
```

#### Webhook
```typescript
POST /webhook/confirm            // 确认执行
POST /webhook/execution-complete // 执行完成
POST /webhook/heartbeat          // 心跳
```

---

## 6. 数据类型定义

### 6.1 Account（账号）

```typescript
interface Account {
  id: string;
  shadow_bot_account: string;  // 影刀账号名
  host_ip: string;             // 主机 IP
  port: number;                // 连接端口
  recent_app?: string | null;  // 最近运行的应用
  status: 'pending' | 'completed' | 'failed' | 'running';
  end_time?: string | null;    // 结束时间
  task_control: string;        // 控制标识（格式：account-ip:port）
  task_count: number;          // 关联任务数
  created_at: string;
  updated_at: string;
}
```

### 6.2 Task（任务）

```typescript
interface Task {
  id: string;
  task_name: string;           // 任务名称
  shadow_bot_account: string;  // 关联账号
  host_ip: string;             // 主机 IP
  app_name: string;            // 应用名称
  last_run_time?: string | null;
  status: 'pending' | 'running';
  config_file: boolean;        // 是否启用配置文件
  config_info: boolean;        // 是否启用配置信息
  config_file_path?: string | null;  // OSS URL
  config_json?: string | null;       // JSON 配置
  trigger_time?: string | null;
  account_port?: number;       // 从账号获取的端口
  created_at: string;
  updated_at: string;
}
```

### 6.3 ExecutionLog（执行日志）

```typescript
interface ExecutionLog {
  id: string;
  text: string;                // 日志摘要
  app_name: string;            // 应用名称
  shadow_bot_account: string;  // 影刀账号
  status: 'completed' | 'failed';
  start_time: string;          // 开始时间
  end_time: string;            // 结束时间
  duration: number;            // 执行时长（秒）
  host_ip: string;             // 主机 IP
  log_info: boolean;           // 是否有日志
  screenshot: boolean;         // 是否有截图
  screenshot_path?: string | null;  // 截图路径/URL
  log_content?: string | null;      // 日志内容
  created_at: string;
}
```

---

## 7. 状态管理

### 7.1 认证上下文

文件：`frontend/src/contexts/authContext.ts`

```typescript
interface AuthContext {
  isAuthenticated: boolean;     // 是否已认证
  setIsAuthenticated: (value: boolean) => void;
  logout: () => void;
}
```

当前实现为硬编码已认证状态。

### 7.2 主题管理

文件：`frontend/src/hooks/useTheme.ts`

- 支持明/暗模式切换
- localStorage 持久化
- 自动检测系统偏好

### 7.3 SSE 实时通信

文件：`frontend/src/hooks/useSSE.ts`

**功能**：
- 自动连接 SSE 事件流
- 心跳保活（30秒）
- 自动重连
- 事件订阅机制

**事件类型**：
- `log_created`：新日志创建
- `account_updated`：账号更新
- `task_updated`：任务更新
- `heartbeat`：心跳

---

## 8. 资源管理

### 8.1 资源 URL 获取

文件：`frontend/src/lib/api.ts`

```typescript
// 获取资源完整 URL（支持本地路径和云端 URL）
getResourceUrl(path?: string | null): string {
  // 云端资源：通过后端代理访问
  if (path.startsWith('http://') || path.startsWith('https://')) {
    return `${API_BASE_URL}/resources/proxy?url=${encodeURIComponent(path)}`;
  }
  // 本地路径：直接拼接
  return path.startsWith('/') ? `http://localhost:8888${path}` : path;
}
```

### 8.2 缓存策略

- 资源文件：浏览器缓存 15 天（后端设置 Cache-Control）
- 下载链接：不缓存，确保获取最新版本

---

## 9. 路由配置

文件：`frontend/src/App.tsx`

```typescript
<Routes>
  <Route path="/" element={<Dashboard />} />
  <Route path="/dashboard" element={<Dashboard />} />
  <Route path="/account-management" element={<AccountManagement />} />
  <Route path="/task-control" element={<TaskControl />} />
  <Route path="/execution-logs" element={<ExecutionLogs />} />
</Routes>
```

---

## 10. 环境配置

文件：`frontend/.env`

```bash
VITE_API_BASE_URL=http://localhost:8888/api/v1
```

---

## 11. 启动命令

```bash
# 安装依赖
pnpm install

# 开发模式
pnpm dev

# 构建生产版本
pnpm build
```

---

## 12. 注意事项

1. **API 命名规范**：使用 `snake_case`，与后端一致
2. **资源路径**：云端资源通过后端代理访问，支持 HTTP 缓存
3. **实时更新**：通过 SSE 实现跨组件数据同步
4. **类型定义**：前端类型定义在后端 Pydantic schemas 基础上编写
