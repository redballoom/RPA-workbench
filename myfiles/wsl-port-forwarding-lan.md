# WSL 端口转发配置（局域网访问）

> 2026-01-31

---

## What（什么问题）

**现象**：局域网内其他电脑无法访问后端服务

**错误信息**：
```
由于目标计算机积极拒绝，无法连接。 (192.168.4.205:8888)
```

**请求地址**：`http://192.168.4.205:8888/api/v1/webhook/confirm`

---

## Why（为什么发生）

**根本原因**：端口转发的 `connectaddress` 配置错误

| 网络层级 | IP 地址 | 说明 |
|---------|---------|------|
| 局域网电脑 | 192.168.4.205 | Windows 主机地址 |
| Windows 本机 | 127.0.0.1 / localhost | Windows 自身 |
| WSL | 172.30.233.159 | WSL 虚拟网络地址 |
| 后端服务 | 172.30.233.159:8888 | 实际运行位置 |

**错误配置**：
```
Windows(0.0.0.0:8888) → localhost:8888(Windows自己) → ❌ 无服务
```

**正确配置**：
```
Windows(0.0.0.0:8888) → 172.30.233.159:8888(WSL) → ✅ 后端服务
```

**缺少的配置**：
- 没有配置 `127.0.0.1` 的转发，导致本机访问也可能失败

---

## When（何时发生/解决）

| 时间 | 事件 |
|------|------|
| 2026-01-31 18:10 | 配置了端口转发但使用错误的 connectaddress |
| 2026-01-31 18:30 | 发现局域网无法访问 |
| 2026-01-31 18:35 | 分析原因并修复配置 |

---

## How（如何解决）

### 解决方案：配置指向 WSL IP 的端口转发

在 **Windows PowerShell（管理员）** 中执行：

```powershell
# ========== 步骤 1：删除旧配置 ==========
netsh interface portproxy delete v4tov4 listenport=8888 listenaddress=0.0.0.0
netsh interface portproxy delete v4tov4 listenport=8888 listenaddress=127.0.0.1

# ========== 步骤 2：添加正确配置 ==========
# 局域网访问转发（0.0.0.0 监听所有网卡）
netsh interface portproxy add v4tov4 listenport=8888 listenaddress=0.0.0.0 connectport=8888 connectaddress=172.30.233.159

# 本机访问转发（127.0.0.1 监听本地回环）
netsh interface portproxy add v4tov4 listenport=8888 listenaddress=127.0.0.1 connectport=8888 connectaddress=172.30.233.159

# ========== 步骤 3：允许防火墙 ==========
netsh advfirewall firewall add rule name="RPA Backend 8888" dir=in action=allow protocol=TCP localport=8888
```

### 获取 WSL IP 地址

```bash
# 在 WSL 中执行
hostname -I
```

输出示例：`172.30.233.159`

### 验证配置

```powershell
# 查看端口转发规则
netsh interface portproxy show all
```

**预期输出**：
```
监听 IPv4          连接到 IPv4

地址            端口            地址            端口
--------------- --------------- --------------- ---------------
0.0.0.0         8888            172.30.233.159  8888
127.0.0.1       8888            172.30.233.159  8888
```

### 测试访问

| 位置 | 访问地址 | 预期结果 |
|------|----------|----------|
| Windows 本机 | `http://localhost:8888` | ✅ 正常 |
| Windows 本机 | `http://127.0.0.1:8888` | ✅ 正常 |
| 局域网电脑 | `http://192.168.4.205:8888` | ✅ 正常 |

---

## 网络拓扑图

```
┌─────────────────────────────────────────────────────────────┐
│                      局域网 (192.168.4.0/24)                  │
│                                                             │
│  ┌──────────────┐         ┌──────────────────────────┐      │
│  │  局域网电脑   │         │     Windows 主机          │      │
│  │              │         │                          │      │
│  │ 请求:        │         │  [0.0.0.0:8888] ────┐    │      │
│  │ 192.168.4.205│────────▶│  [127.0.0.1:8888] ──┼───│──────┼──▶ WSL
│  │ :8888        │         │        │              │    │      │  172.30.233.159
│  └──────────────┘         │        ▼              │    │      │  :8888
│                           │  connectaddress=      │    │      │
│                           │  172.30.233.159       │    │      │
│                           └──────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
                        后端服务正常响应
```

---

## 总结

| 项目 | 内容 |
|------|------|
| 问题类型 | Windows 端口转发配置错误 |
| 错误配置 | connectaddress=localhost |
| 正确配置 | connectaddress=172.30.233.159 (WSL IP) |
| 需要配置 | 0.0.0.0 和 127.0.0.1 两个监听地址 |
| 状态 | ✅ 待验证 |

---

## 注意事项

1. **WSL IP 可能变化**：每次重启 WSL 后 IP 可能改变，需要重新配置
2. **永久化方案**：可编写脚本或使用工具自动更新端口转发
3. **防火墙**：确保 Windows 防火墙允许 8888 端口入站
